generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model accounts {
  id                  Int     @id @default(autoincrement())
  user_id             Int
  type                String
  provider            String
  provider_account_id String
  refresh_token       String?
  access_token        String?
  expires_at          Int?
  token_type          String?
  scope               String?
  id_token            String?
  session_state       String?
  users               users   @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([provider, provider_account_id])
}

model age_grading_factors {
  id          Int     @id @default(autoincrement())
  gender      String
  event       String
  open_record Decimal @db.Decimal(10, 4)
  age         Int
  factor      Decimal @db.Decimal(6, 4)

  @@unique([gender, event, age])
  @@index([gender, event])
}

model athlete_lookups {
  id           Int      @id @default(autoincrement())
  source       String
  athlete_id   String
  athlete_name String?
  lookup_at    DateTime @default(now())
  ip_address   String?

  @@index([lookup_at])
  @@index([source, athlete_id])
}

model films {
  id               Int      @id @default(autoincrement())
  title            String
  slug             String   @unique
  description      String?
  youtube_id       String?
  vimeo_id         String?
  thumbnail_url    String?
  duration_seconds Int?
  year             Int?
  awards           String[]
  featured         Boolean  @default(false)
  created_at       DateTime @default(now())
}

model media {
  id         Int      @id @default(autoincrement())
  filename   String
  url        String
  alt_text   String?
  mime_type  String?
  size_bytes Int?
  width      Int?
  height     Int?
  post_id    Int?
  created_at DateTime @default(now())
  posts      posts?   @relation(fields: [post_id], references: [id])
}

model orders {
  id                Int      @id @default(autoincrement())
  user_id           Int?
  stripe_session_id String?
  status            String   @default("pending")
  total_cents       Int
  currency          String   @default("GBP")
  shipping_address  Json?
  items             Json
  created_at        DateTime @default(now())
  updated_at        DateTime
  users             users?   @relation(fields: [user_id], references: [id])

  @@index([status])
  @@index([user_id])
}

model parkrun_athletes {
  id                   Int      @id @default(autoincrement())
  athlete_id           String   @unique
  name                 String
  total_runs           Int
  best_time_seconds    Int?
  average_time_seconds Int?
  typical_avg_seconds  Int?
  recent_avg_seconds   Int?
  avg_age_grade        Decimal? @db.Decimal(5, 2)
  recent_avg_age_grade Decimal? @db.Decimal(5, 2)
  pb_date              String?
  pb_event             String?
  pb_age               String?
  trend                String?
  trend_message        String?
  outlier_count        Int      @default(0)
  normal_run_count     Int      @default(0)
  recent_results_json  Json?
  lookup_count         Int      @default(1)
  created_at           DateTime @default(now())
  updated_at           DateTime
  last_lookup_at       DateTime @default(now())

  @@index([athlete_id])
  @@index([last_lookup_at])
}

model po10_athletes {
  id                    Int      @id @default(autoincrement())
  athlete_id            String   @unique
  name                  String
  club                  String?
  gender                String?
  age_group             String?
  pbs_json              Json?
  overall_percentile    Decimal? @db.Decimal(5, 2)
  overall_age_grade     Decimal? @db.Decimal(5, 2)
  overall_ability_level String?
  lookup_count          Int      @default(1)
  created_at            DateTime @default(now())
  updated_at            DateTime
  last_lookup_at        DateTime @default(now())

  @@index([athlete_id])
  @@index([last_lookup_at])
}

model post_terms {
  post_id Int
  term_id Int
  posts   posts @relation(fields: [post_id], references: [id], onDelete: Cascade)
  terms   terms @relation(fields: [term_id], references: [id], onDelete: Cascade)

  @@id([post_id, term_id])
}

model posts {
  id             Int          @id @default(autoincrement())
  wp_id          Int?         @unique
  title          String
  slug           String       @unique
  content        String
  excerpt        String?
  featured_image String?
  status         String       @default("published")
  post_type      String       @default("post")
  read_time      Int          @default(5)
  author_id      Int?
  created_at     DateTime     @default(now())
  updated_at     DateTime
  published_at   DateTime?
  meta           Json         @default("{}")
  media          media[]
  post_terms     post_terms[]
  users          users?       @relation(fields: [author_id], references: [id])

  @@index([created_at])
  @@index([status, post_type])
}

model products {
  id                  Int      @id @default(autoincrement())
  name                String
  slug                String   @unique
  description         String?
  price_cents         Int
  compare_price_cents Int?
  currency            String   @default("GBP")
  images              String[]
  category            String?
  inventory_count     Int      @default(0)
  is_digital          Boolean  @default(false)
  stripe_price_id     String?
  status              String   @default("active")
  created_at          DateTime @default(now())
  updated_at          DateTime

  @@index([category])
  @@index([status])
}

model races {
  id           Int      @id @default(autoincrement())
  date         DateTime @db.Date
  event        String
  type         String?
  distance_km  Decimal? @db.Decimal(10, 3)
  time_hms     String?
  time_seconds Int?
  elevation    Int?
  position     String?
  terrain      String?
  video_url    String?
  strava_url   String?
  results_url  String?
  created_at   DateTime @default(now())
  updated_at   DateTime

  @@index([date])
  @@index([type])
}

model saved_routes {
  id         Int      @id @default(autoincrement())
  user_id    Int
  name       String
  route_data Json
  created_at DateTime @default(now())
  users      users    @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model sessions {
  id            Int      @id @default(autoincrement())
  session_token String   @unique
  user_id       Int
  expires       DateTime
  users         users    @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model settings {
  key        String   @id
  value      Json
  updated_at DateTime
}

model terms {
  id          Int          @id @default(autoincrement())
  name        String
  slug        String       @unique
  taxonomy    String
  description String?
  post_terms  post_terms[]

  @@index([taxonomy])
}

model users {
  id                 Int            @id @default(autoincrement())
  email              String         @unique
  name               String?
  password_hash      String?
  stripe_customer_id String?
  created_at         DateTime       @default(now())
  updated_at         DateTime
  access_tier        AccessTier     @default(FREE)
  email_verified_at  DateTime?
  image              String?
  subscription_end   DateTime?
  accounts           accounts[]
  orders             orders[]
  posts              posts[]
  saved_routes       saved_routes[]
  sessions           sessions[]
}

model verification_tokens {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum AccessTier {
  FREE
  PREMIUM
  PRO
}
